From: Colin Walters <walters@verbum.org>
Date: Thu, 22 Aug 2013 17:37:31 -0400
Subject: [PATCH] pkit: Pass system-bus-name as subject, not pid

Previously, we were forcing polkit to scrape /proc/pid itself for the
uid, which is subject to a race condition if the caller execve()s a
setuid binary.  Passing system-bus-name as a subject allows polkit to
use the valid information from the system bus.
---
 base/pkit.py |    9 ++-------
 1 files changed, 2 insertions(+), 7 deletions(-)

Index: hplip-3.13.9/base/pkit.py
===================================================================
--- hplip-3.13.9.orig/base/pkit.py	2013-09-05 18:53:46.000000000 +1000
+++ hplip-3.13.9/base/pkit.py	2013-09-21 08:17:27.000000000 +1000
@@ -176,15 +176,10 @@
                                     "/org/freedesktop/PolicyKit1/Authority",
                                     "org.freedesktop.PolicyKit1.Authority")
         policy_kit = dbus.Interface(obj, "org.freedesktop.PolicyKit1.Authority")
-        info = dbus.Interface(connection.get_object("org.freedesktop.DBus",
-                                                    "/org/freedesktop/DBus/Bus",
-                                                    False),
-                              "org.freedesktop.DBus")
-        pid = info.GetConnectionUnixProcessID(sender)
         
         subject = (
-            'unix-process',
-            { 'pid' : dbus.UInt32(pid, variant_level = 1) }
+            'system-bus-name',
+            { 'name' : dbus.String(sender, variant_level = 1) }
         )
         details = { '' : '' }
         flags = dbus.UInt32(1)         # AllowUserInteraction = 0x00000001
