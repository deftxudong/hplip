#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2007-5208.dpatch by Nico Golde <nion@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad hplip-1.6.10~/hpssd.py hplip-1.6.10/hpssd.py
--- hplip-1.6.10~/hpssd.py	2006-10-03 21:55:01.000000000 +0200
+++ hplip-1.6.10/hpssd.py	2007-10-22 13:44:45.000000000 +0200
@@ -53,7 +53,7 @@
 
 # Std Lib
 import sys, socket, os, os.path, signal, getopt, glob, time, select
-import popen2, threading, gettext, re, xml.parsers.expat, fcntl
+import subprocess, threading, gettext, re, xml.parsers.expat, fcntl
 import cStringIO, pwd
 
 from errno import EALREADY, EINPROGRESS, EWOULDBLOCK, ECONNRESET, \
@@ -1383,21 +1383,23 @@
         
         if sendmail:
             sendmail = os.path.join(sendmail, 'sendmail')
-            sendmail += ' -t -r %s' % self.from_address
+            cmd = [sendmail,'-t','-r',self.from_address]
             
-            log.debug(sendmail)
-            std_out, std_in, std_err = popen2.popen3(sendmail) 
-            log.debug(repr(self.message))
-            std_in.write(self.message)
-            std_in.close()
+            log.debug(repr(cmd))
+            err = None
+            try:
+                sp = subprocess.Popen(cmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
+                std_out, std_err = sp.communicate(self.message)
+                log.debug(repr(self.message))
+                if std_err != '':
+                    err = std_err
             
-            r, w, e = select.select([std_err], [], [], 2.0)
+            except OSError, e:
+                err = str(e)
             
-            if r:
-                err = std_err.read()
-                if err:
-                    log.error(repr(err))
-                    self.result = ERROR_TEST_EMAIL_FAILED
+            if err:
+                log.error(repr(err))
+                self.result = ERROR_TEST_EMAIL_FAILED
             
         else:
             log.error("Mail send failed. sendmail not found.")

